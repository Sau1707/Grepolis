// ==UserScript==
// @name         GrepoTweaks-Merged
// @namespace    grepotweaksmerged
// @author       Sau1707
// @description  All the GrepoTweaks merged in a single script
// @version      1.3.0
// @match        http://*.grepolis.com/game/*
// @match        https://*.grepolis.com/game/*
// @match        https://sau1707.github.io/Grepolis/
// @require      https://github.com/Sau1707/Grepolis/raw/main/update.js
// ==/UserScript==


!function(){"use strict";const n=unsafeWindow||window;let o;function e(){var e=document.getElementsByClassName("order_max button_new")[0],t=document.getElementsByClassName("order_confirm button_new square")[0];null!=e&&null!=t||clearInterval(o),5e3<n.ITowns.towns[n.Game.townId].resources().iron&&(e.click(),t.click())}function s(){var e=document.getElementsByClassName("order_count")[0],t=document.createElement("div");t.className="button_new",t.id="autoCaveButton",t.style="float: right; margin: 0px; left: 169px; position: absolute; top: 56px; width: 66px",t.innerHTML='<div class="left"></div><div class="right"></div><div class="caption js-caption"> Auto <div class="effect js-effect"></div></div>',e.insertBefore(t,e.childNodes[0])}function i(){n.$("#autoCaveButton").click(()=>{o=o?(n.$("#autoCaveButton").css("filter",""),clearInterval(o),null):(n.$("#autoCaveButton").css("filter","brightness(100%) sepia(100%) hue-rotate(90deg) saturate(1500%) contrast(0.8)"),setInterval(e,1e3))})}n.$.Observer(n.GameEvents.town.town_switch).subscribe((e,t)=>{setTimeout(()=>{document.getElementById("autoCaveButton")||document.getElementsByClassName("js-window-main-container classic_window hide")[0]&&(s(),i(),setTimeout(()=>document.getElementsByClassName("order_max button_new")[0].click(),500))},100)}),n.$.Observer(n.GameEvents.window.open).subscribe((e,t)=>{t.attributes&&"hide"==t.attributes.window_type&&setTimeout(()=>{s(),i(),setTimeout(()=>document.getElementsByClassName("order_max button_new")[0].click(),500)},200)}),console.log("[GrepoTweaks-AutoCave] Loaded")}(),function(){"use strict";const a=unsafeWindow||window;function l(e){var t=3<(t=a.ITowns.getCurrentTown().getLandUnits()).sword?"sword":3<t.archer?"archer":3<t.hoplite?"hoplite":null;t?((e={id:e=e.id,type:"support"})[t]=3,a.gpAjax.ajaxPost("town_info","send_units",e)):a.HumanMessage.error("No troops available")}a.$.Observer(a.GameEvents.map.town.click).subscribe((e,t)=>{var n,o,s,i;if((n=t.x,o=t.y,i=(s=a.ITowns.getCurrentTown()).getIslandCoordinateX(),s=s.getIslandCoordinateY(),i==n&&s==o)&&(!function(e){var t,n;for(t of Object.keys(a.ITowns.towns)){if(t==e)return 1;for(n of a.ITowns.all_supporting_units.fragments[t].models)if(n.attributes.current_town_id==e)return 1}}(t.id)&&!function(e){var t,n=a.MM.getModels().MovementsUnits;for(t in n)if(n[t].attributes.target_town_id==e)return 1}(t.id))){let e=a.$("#context_menu");e&&((i=document.createElement("div")).id="sentinel_button",i.style.width="50px",i.style.height="50px",i.style.position="absolute",i.style.background="url(https://i.ibb.co/9wwBNfD/sentinel.png)",i.style.zIndex="auto",i.style.cursor="pointer",i.innerHTML=`        <div id="sentinel_description" style="position: absolute;overflow: hidden;width: 118px;display: none;margin-left: -59px;left: 50%;top: 40px;z-index: 5;" >        <div style="position: absolute; top: 0; left: 0; right: 0; background: url(https://gpit.innogamescdn.com/images/game/autogenerated/layout/layout_095495a.png) no-repeat -488px -406px; width: 118px; height: 18px;"></div>        <div style="position: absolute; top: 18px; left: 0; right: 0; bottom: 11px; background: url(https://gpit.innogamescdn.com/images/game/layout/context_menu_middle.png) repeat-y 0 0;"></div>        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: url(https://gpit.innogamescdn.com/images/game/autogenerated/layout/layout_095495a.png) no-repeat -326px -240px; width: 118px; height: 11px;"></div>        <div style="color: #fc6; font-weight: 700; text-align: center; word-wrap: break-word; line-height: 19px; z-index: 1; position: relative; padding: 4px;">Sentinel</div>        </div>`,e.append(i),a.$("#sentinel_button").animate({top:"-100px"},120),a.$("#sentinel_button").hover(()=>{a.$("#sentinel_description").css("display","block")},()=>{a.$("#sentinel_description").css("display","none")}),a.$("#sentinel_button").click(()=>{l(t),e.remove()}))}})}(),function(){"use strict";const o=unsafeWindow;let s=[];function n(){var e=Object.keys(o.ITowns.towns);let t=[];e.forEach(e=>{o.ITowns.all_supporting_units.fragments[e].models.forEach(e=>{e=e.attributes;-1===t.indexOf(e.current_town_id)&&t.push(e.current_town_id)})});var e=s.filter(e=>!t.includes(e)),n=t.filter(e=>!s.includes(e));e.forEach(e=>{e=e,(e=document.getElementById("sentinel_shield_"+e))&&e.remove()}),n.forEach(e=>{!function(e){var t,n,o=document.getElementById("town_"+e);if(o)return t=parseInt(o.style.left),o=parseInt(o.style.top),(n=document.createElement("div")).id="sentinel_shield_"+e,n.style.left=t-29+"px",n.style.top=o-25+"px",n.style.background="url(https://gpit.innogamescdn.com/images/game/autogenerated/map/town_overlay/city_shield_cd2b0df.png) no-repeat 0 0",n.style.width="110px",n.style.height="72px",n.style.position="absolute",n.style.transform="translate(10px,10px)",n.style.backgroundSize="95%",n.style.filter="grayscale(100%) brightness(80%) sepia(300%) hue-rotate(50deg) saturate(500%)",document.getElementById("map_sentinel").appendChild(n),1}(e)&&t.splice(t.indexOf(e),1)}),s=t}window.addEventListener("load",e=>{setTimeout(()=>{var e,t;e=document.getElementById("map_move_container"),(t=document.createElement("div")).id="map_sentinel",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.zIndex="5",t.style.pointerEvents="none",t.style.opacity="0.6",e.appendChild(t),e=document.getElementById("map_islands"),new MutationObserver(n).observe(e,{childList:!0,attributes:!0,subtree:!0}),n()},500)}),console.log("[GrepoTweaks-SentinelIndicator] Loaded")}();